# 热量限制

在 rm_control/rm_common/include/rm_common/desion 里面的heat_limit.h文件中有和热量限制有关的代码

```
  void heatCB(const rm_msgs::LocalHeatStateConstPtr& msg)
  {
    if (msg->has_shoot)
      local_shooter_cooling_heat_ += bullet_heat_;
  }

  void timerCB()
  {
    if (local_shooter_cooling_heat_ > 0.0)
      local_shooter_cooling_heat_ -= shooter_cooling_rate_ / 10.0;
    if (local_shooter_cooling_heat_ < 0.0)
      local_shooter_cooling_heat_ = 0.0;
    std_msgs::Float64 msg;
    msg.data = local_shooter_cooling_heat_;
    local_heat_pub_.publish(msg);
  }
```

- 这里是简单地在本地对当前热量进行计算，即每打一发弹会增加多少热量，每0.1秒会减少多少热量

- heatCB是在打弹的时候调用的函数，判断打弹的方式则是打弹的时候摩擦轮会存在一个降速再升速的过程，以这种变化来判断打出了一发子弹（这里的变化阈值是我们需要调整的参数）

- 但在这里会有一个小问题，就是两个函数调用的是同一个变量，可能存在两个函数同时调用的情况，就可能导致出现错误

  ```
    double getShootFrequency() const
    {
      if (state_ == BURST)
        return shoot_frequency_;
      double shooter_cooling_heat =
          (use_local_heat_ || !referee_is_online_) ? local_shooter_cooling_heat_ : shooter_cooling_heat_;
      if (shooter_cooling_limit_ - shooter_cooling_heat < bullet_heat_)
        return 0.0;
      else if (shooter_cooling_limit_ - shooter_cooling_heat == bullet_heat_)
        return shooter_cooling_rate_ / bullet_heat_;
      else if (shooter_cooling_limit_ - shooter_cooling_heat <= bullet_heat_ * heat_coeff_)
        return (shooter_cooling_limit_ - shooter_cooling_heat) / (bullet_heat_ * heat_coeff_) *
                   (shoot_frequency_ - shooter_cooling_rate_ / bullet_heat_) +
               shooter_cooling_rate_ / bullet_heat_;
      else
        return shoot_frequency_;
    }
  ```

- 在这里一开始会进行对本地热量的选择（当前热量有我们本地计算出来，也就是上文的热量，也有裁判系统给我们的热量）
- 后续是对子弹射击频率的计算
- 当剩下的热量空间比单发产生的热量还要小的时候，return 0，也就是说让子弹停止发射
- 当剩下的热量空间和单发产生的热量相同的时候，return shooter_cooling_rate/bullet_heart_ ，这里表示的就是每秒冷却速率/单发产生的热量，表示的值也就是可以让当前热量不会变化的射击频率
- 当剩下的热量空间小于bullet_heart*heat_coeff_，这里的heat_coeff_是我们给定的一个参数，整个可以看作我们设定多少发子弹产生的热量大小作为热量警告区域。
- shoot_frequrency-shoote_cooling_rate/bullet_heat_   这里写的是期望的速度减去让热量不会变化的射击频率，得出来的就是期望射击中会让热量上升的发射频率那一部分。
- 整个部分可以理解为让小于热量警告区域的部分只能以特定的填充速率进行热量填充
- eg ：热量警告区域为100，期望射击频率中会导致热量填充的射击频率为2，而单发热量为5，此时热量填充速率为（100/100）2*5/100，也就是10%的填充效率
- 当剩余热量空间不足100，例如90的时候，期望射击频率中会导致热量填充的射击频率为2，单发热量为5，此时的热量填充效率为 （90/100）2*5/90，仍旧是10%的填充效率
- 通过这种计算方式，可以让射击频率按照一个二次函数的曲线进行下降，防止热量超限